name: Terraform Security Audit

on:
  pull_request:
    paths:
      - '**.tf'
  push:
    branches:
      - main
    paths:
      - '**.tf'
  workflow_dispatch:
    inputs:
      filepath:
        description: 'Path to the Terraform file to audit'
        required: true
        default: 'test'

permissions:
  pull-requests: write

jobs:
  iac-security-audit:
    runs-on: ubuntu-latest
    outputs:
      audit-results: ${{ steps.audit_step.outputs.audit_results }}
      audit-outcome: ${{ steps.audit_step.outcome }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run AI Security Auditor
        id: audit_step
        run: |
          FILEPATH="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.filepath || 'test' }}"
          
          echo "üîç Running security audit on: $FILEPATH"
          
          # Capture both stdout and stderr
          if python3 main.py "$FILEPATH" > audit_output.txt 2>&1; then
            AUDIT_RESULT="success"
          else
            AUDIT_RESULT="failed"
          fi
          
          # Read the output and set as output variable
          AUDIT_OUTPUT=$(cat audit_output.txt)
          echo "audit_results<<EOF" >> $GITHUB_OUTPUT
          echo "$AUDIT_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "audit_outcome=$AUDIT_RESULT" >> $GITHUB_OUTPUT
          
          # Write to job summary
          echo "## ü§ñ AI Security Audit Summary" >> $GITHUB_STEP_SUMMARY
          if [ "$AUDIT_RESULT" = "failed" ]; then
            echo "### ‚ùå Status: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "Vulnerabilities were detected. See the logs and the PR comment for details." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚úÖ Status: PASSED" >> $GITHUB_STEP_SUMMARY
            echo "No security vulnerabilities were detected." >> $GITHUB_STEP_SUMMARY
          fi
          echo "**Path Analyzed:** \`$FILEPATH\`" >> $GITHUB_STEP_SUMMARY

          # Display the full logs in the step output
          cat audit_output.txt
          
          if [ "$AUDIT_RESULT" = "failed" ]; then
            exit 1
          fi
        env:
          HUGGING_FACE_HUB_TOKEN: ${{ secrets.HUGGING_FACE_HUB_TOKEN }}

  add-pr-comment:
    needs: iac-security-audit
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'pull_request'
    steps:
      - name: Post Audit Results as a PR Comment
        uses: actions/github-script@v7
        env:
          AUDIT_OUTCOME: ${{ needs.iac-security-audit.outputs.audit-outcome }}
          AUDIT_RESULTS: ${{ needs.iac-security-audit.outputs.audit-results }}
        with:
          script: |
            const auditOutcome = process.env.AUDIT_OUTCOME;
            const auditResults = process.env.AUDIT_RESULTS;
            
            let commentBody = `## ü§ñ AI Security Audit Results\n\n`;
            
            if (auditOutcome === 'success') {
              commentBody += `‚úÖ **PASSED** - No security vulnerabilities detected!`;
            } else {
              commentBody += `‚ùå **FAILED** - Vulnerabilities were detected!\n\n`;
              
              // This detailed formatting logic is now restored
              let formattedResults = auditResults
                .replace(/üîç Auditing.*?\n/g, '')
                .replace(/ü§ñ Initializing.*?\n/g, '')
                .replace(/‚úÖ AI security auditor initialized successfully\.\n/g, '')
                .replace(/--- Analyzing '([^']+)' ---/g, '### üìÑ File: `$1`')
                .replace(/ü§ñ Sending request to remote AI model\.\.\.\n/g, '')
                .replace(/Security Analysis Result for '[^']+':?\n/g, '')
                .replace(/‚ùå Security vulnerabilities detected.*?\n/g, '')
                .trim();

              commentBody += formattedResults;
            }
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });
